<!DOCTYPE html>
<html lang="ru">
  <head>
    <title>Просмотр трека на Yandex Maps</title>
    <meta charset="UTF-8" />
    <style>
      body {
        margin: 0;
        background: white;
        color: black;
        transition: background 0.3s, color 0.3s;
      }
      body.dark {
        background: #121212;
        color: white;
      }
      #map {
        width: 100%;
        height: 100vh;
      }
      #metrics {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        font-family: Arial;
        transition: background 0.3s, color 0.3s;
      }
      body.dark #metrics {
        background: #333;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      }
      /* Стили для свитчера */
      .theme-switcher {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        display: flex;
        align-items: center;
      }
      .theme-switcher input {
        display: none;
      }
      .theme-switcher label {
        cursor: pointer;
        background: #ccc;
        border-radius: 20px;
        width: 40px;
        height: 20px;
        position: relative;
        transition: background 0.3s;
      }
      .theme-switcher label::before {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        width: 16px;
        height: 16px;
        background: white;
        border-radius: 50%;
        transition: left 0.3s;
      }
      .theme-switcher input:checked + label {
        background: #4caf50;
      }
      .theme-switcher input:checked + label::before {
        left: 22px;
      }
      .theme-switcher span {
        margin-left: 10px;
        font-family: Arial;
      }
    </style>
    <!-- Загрузка Yandex Maps API v3 как глобального скрипта -->
    <script src="https://api-maps.yandex.ru/v3/?apikey=c8428a41-6aae-40c0-a007-14223f034541&lang=ru_RU"></script>
  </head>
  <body>
    <input
      type="file"
      id="fileInput"
      accept=".json"
      style="position: absolute; top: 10px; left: 10px; z-index: 10"
    />
    <div class="theme-switcher">
      <input type="checkbox" id="themeToggle" />
      <label for="themeToggle"></label>
      <span>Тёмная тема</span>
    </div>
    <div id="map"></div>
    <div id="metrics"></div>

    <script type="module">
      ymaps3.ready.then(() => {
        const {
          YMap,
          YMapDefaultSchemeLayer,
          YMapDefaultFeaturesLayer,
          YMapFeature,
        } = ymaps3;

        // Инициализация карты с начальной темой 'light'
        let currentTheme = "light";
        let schemeLayer = new YMapDefaultSchemeLayer({ theme: currentTheme });

        const map = new YMap(
          document.getElementById("map"),
          { location: { center: [37.618423, 55.751244], zoom: 10 } },
          [schemeLayer, new YMapDefaultFeaturesLayer({})]
        );

        // Обработчик свитчера темы
        const themeToggle = document.getElementById("themeToggle");
        themeToggle.addEventListener("change", () => {
          const newTheme = themeToggle.checked ? "dark" : "light";
          document.body.classList.toggle("dark", themeToggle.checked);

          // Замена слоя схемы для изменения темы карты
          map.removeChild(schemeLayer);
          schemeLayer = new YMapDefaultSchemeLayer({ theme: newTheme });
          map.addChild(schemeLayer, 0); // Добавляем на нижний уровень (под features)
        });

        class GPSKalmanFilter {
          constructor(decay = 3) {
            this.decay = decay;
            this.variance = -1;
            this.minAccuracy = 1;
          }

          process(lat, lng, accuracy, timestampInMs) {
            if (accuracy < this.minAccuracy) accuracy = this.minAccuracy;

            if (this.variance < 0) {
              this.timestampInMs = timestampInMs;
              this.lat = lat;
              this.lng = lng;
              this.variance = accuracy * accuracy;
            } else {
              const timeIncMs = timestampInMs - this.timestampInMs;

              if (timeIncMs > 0) {
                this.variance += (timeIncMs * this.decay * this.decay) / 1000;
                this.timestampInMs = timestampInMs;
              }

              const _k = this.variance / (this.variance + accuracy * accuracy);
              this.lat += _k * (lat - this.lat);
              this.lng += _k * (lng - this.lng);

              this.variance = (1 - _k) * this.variance;
            }

            return [this.lng, this.lat];
          }
        }

        // Обработчик загрузки JSON (без изменений)
        document
          .getElementById("fileInput")
          .addEventListener("change", event => {
            const file = event.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = e => {
                const track = JSON.parse(e.target.result);
                const rawPoints = track.route.map(p => ({
                  lat: p.lat,
                  lon: p.lon /*, timestamp: p.timestamp если есть */,
                }));

                // Применяем фильтр Калмана
                const kalmanFilter = new GPSKalmanFilter(3); // decay = 3 м/с
                const smoothedPoints = [];
                const defaultAccuracy = 5; // Фиксированная точность в метрах (подстройте)
                rawPoints.forEach((p, index) => {
                  const timestampInMs = index * 1000; // Имитация: 1 сек на точку (если есть p.timestamp, используйте p.timestamp * 1000)
                  const [smoothedLon, smoothedLat] = kalmanFilter.process(
                    p.lat,
                    p.lon,
                    defaultAccuracy,
                    timestampInMs
                  );
                  smoothedPoints.push([smoothedLon, smoothedLat]);
                });

                // Отрисовка сглаженной линии
                const line = new YMapFeature({
                  geometry: {
                    type: "LineString",
                    coordinates: smoothedPoints,
                  },
                  style: { stroke: [{ color: "#DE340D", width: 5 }] },
                });
                map.addChild(line);

                // Расчёт bounds на основе сглаженных точек
                if (smoothedPoints.length > 0) {
                  let minLon = Math.min(...smoothedPoints.map(p => p[0]));
                  let maxLon = Math.max(...smoothedPoints.map(p => p[0]));
                  let minLat = Math.min(...smoothedPoints.map(p => p[1]));
                  let maxLat = Math.max(...smoothedPoints.map(p => p[1]));
                  const mapBounds = [
                    [minLon, minLat],
                    [maxLon, maxLat],
                  ];

                  map.setLocation({ bounds: mapBounds, duration: 500 });
                }

                const metricsDiv = document.getElementById("metrics");
                metricsDiv.innerHTML = `
                Дистанция: ${track.distance} км<br>
                Время: ${track.time} мин<br>
                Ср. скорость: ${track.avgSpeed} км/ч<br>
                Дата: ${track.date}
              `;
              };
              reader.readAsText(file);
            }
          });
      });
    </script>
  </body>
</html>
